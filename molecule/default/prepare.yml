---
# =============================================================================
# Ansible Role: Fail2ban - Molecule Preparation Playbook
# =============================================================================

- name: "ğŸ§ª Molecule | Prepare"
  hosts: all
  gather_facts: true

  tasks:
    - name: "ğŸ› ï¸ Prepare | Ensure /etc/shadow permissions are secure"
      ansible.builtin.file:
        path: /etc/shadow
        mode: '0400'
        owner: root
        group: root
      when: ansible_facts['service_mgr'] == 'systemd'

    - name: "ğŸ”„ Prepare | Update apt cache"
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false
      when: >
        ansible_facts['os_family'] == "Debian"

    - name: "â³ Prepare | Wait for systemd to complete initialization"
      ansible.builtin.systemd:
        name: multi-user.target
        state: started
      register: systemctl_status
      until: true
      retries: 30
      delay: 5
      when: >
        ansible_facts['service_mgr'] == 'systemd'
      changed_when: false
      failed_when: false

    - name: "ğŸ“ Prepare | Create test log directory"
      ansible.builtin.file:
        path: /var/log/fail2ban-test
        state: directory
        mode: '0755'
        owner: root
        group: root

    - name: "ğŸ“ Prepare | Create test auth log file"
      ansible.builtin.file:
        path: /var/log/auth.log
        state: touch
        mode: '0644'
        owner: root
        group: root

    - name: "ğŸ“Š Prepare | Display preparation summary"
      ansible.builtin.debug:
        msg:
          - "âœ… Molecule preparation completed"
          - "ğŸ”„ Package cache: Updated"
          - "â³ System initialization: Verified"
          - "ğŸ“ Test directories: Created"
